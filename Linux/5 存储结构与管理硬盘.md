## Linux文件结构
Linux系统中的一切文件都是从根目录（/）开始的，并且按照文件系统层次标准（FHS）采用倒树状结构存放。
Linux常见目录名称及其相应内容：

|目录名称|应放置文件的内容|
|----------|----------|
|/boot|开机所需文件——内核、开机菜单以及所需要的配置文件|
|/dev|以文件形式存放任何设备与接口|
|/etc|配置文件|
|/home|用户主目录|
|/bin|存放单用户模式下还可以操作的命令|
|/lib|开机时用到的函数库。以及/bin与/sbin下面的命令要调用的函数|
|/sbin|开机过程中需要的命令|
|/media|用于挂载设备文件的目录|
|/opt|放置第三方的软件|
|/root|系统管理员的主目录|
|/srv|一些网络服务的数据文件目录|
|/tmp|任何用户均可使用的共享临时目录|
|/proc|虚拟文件系统，例如系统内核、进程、外部设备及网络状态等|
|/user/local|用户自行安装的软件|
|/user/sbin|开机时不会使用到的软件、命令和脚本|
|/user/share|帮助说明文件，也可放置共享文件|
|/var|经常变化的文件，例如日志|
|/lost+found|当文件系统发生错误时，将一些丢失的文件片段存放于此|


## 物理设备的命名规则
硬盘设备由大量的扇区组成。
在MBR分区规则下，每个扇区容量为512字节。
第一个扇区保存着主引导记录和分区表信息，其中主引导记录占用446字节，最多四个分区表分别占用16字节，结束符占用2字节。

主分区：也称为引导分区，最多可能创建4个，当创建四个主分区时候，就无法再创建扩展分区了，当然也就没有逻辑分区了。MBR分区表可以划分出4个主分区。

扩展分区：不是一个实际意义的分区，而仅仅是一个指向其他分区的指针，这种指针结构将形成一个单向链表。因此扩展分区自身不能存储数据，用户需要在其指向的对应分区（称之为逻辑分区）上进行操作。

逻辑分区：在扩展分区上可以创建多个逻辑分区。

udev 设备管理器的服务决定了设备在/dev 目录中的名称。
常见硬件色号被及其文件名称：

|硬件设备|文件名称|
|----------|---- |
|IDE设备|/dev/hd[a-d]|
|SCSI/SATA/U盘|/dev/sd[a-d]|
|Virtio设备|/dev/vd[a-z]|
|软驱|/dev/fd[0-1]|
|打印机|/dev/lp[0-15]|
|光驱|/dev/cdrom|
|鼠标|/dev/mouse|
|磁带机|/dev/st0或者/dev/ht0|

一般硬盘设备以“/dev/sd”开头，以a\~z来代表26块不同的硬盘（默认从a开始分配），主分区编号为1\~4，逻辑分区编号从5开始。
例如，对于 /dev/sda5 这个设备文件名称，/dev表示硬件设备文件所在的目录，sd表示SCSI设备，a表示硬盘的顺序编号，5表示硬盘分区的编号，总的表示即为“系统中第一块被识别到的硬件设备中分区编号为5的逻辑分区的设备文件”。

## 文件系统与数据资料
Linux文件系统：
- Ext2：Linux系统的第一个商业级文件系统，基本沿袭了UNIX文件系统的设置标准。
- Ext3：是一款日志文件系统，会将整个硬盘的每个写入动作的细节都预先记录下来， 然后再进行实际操作，以便在发生异常宕机后能回溯追踪到被中断的部分。
- Ext4：Ext3的扩展改进版本，能够批量分配 block（块），极大地提高了读写效率。当前很多主流服务器使用了Ext4文件系统。、
- XFS：是一种高性能的日志文件系统。能够在发生意外宕机后快速地恢复可能被破坏的文件，而且强大的日志功能只需花费极低的计算和存储性能。

**在有一块新的硬盘存储设备后，先需要分区，然后再格式化文件系统，最后才能挂载并正常使用。**

Linux系统将整个文件系统的信息记录在super block中，Linux 将每个文件的权限与属性记录在inode 中，每个文件占用一个独立的 inode 表格，该表格的大小默认为 128 字节，里面记录着如下信息：
- 该文件的访问权限（read、write、execute） 
- 该文件的所有者与所属组（owner、group）
- 该文件的大小（size）
- 该文件的创建或内容修改时间（Ctime）
- 该文件的最后一次访问时间（Atime）
- 该文件的修改时间（Mtime）
- 文件的特殊权限（SUID、SGID、SBIT）
- 该文件的真实数据地址（point）

文件的实际内容则保存在block块中（大小一般是1KB、2KB或4KB），一个inode的默认大小仅为 128 字节，记录一个block则消耗 4 字节。当文件的 inode 被写满后，Linux会自动分配出一个block，专门用于像inode那样记录其他block块的信息。
文件实际占用block数量为：$\lfloor{文件大小/block大小}\rfloor + 1$ ，故通常文件实际大小与其在计算机中的占用空间并不一致。

Linux内核中的软件层为用户程序提供了一个虚拟文件系统（Virtual File System，VFS）接口，用户实际上在操作文件时是统一对该虚拟文件系统进行操作。


## 挂载硬盘设备
### mount命令
`mount 文件系统 文件目录`
用于挂载文件系统。
挂载是在使用硬件设备前所执行的最后一步操作。只需使用 mount 命令将硬盘设备或分区与一个目录文件进行关联，就能在该目录下看到硬件设备中的数据。‘

参数：
- `-a` 挂载所有在/etc/fstab中定义的文件系统
- `-t` 指定文件系统类型

UUID（通用唯一识别码）是一串用于表示每块独立硬盘的字符串，具有唯一性和稳定性。
使用 `blkid [设备名]`命令可以查询设备的UUID值。
使用UUID挂载设备/backup目录：
```Shell
mount UUID=... \backup
```

上述方式挂载的硬盘设备在系统重启后会失效，若要使硬件设备与目录永久性关联，必须将挂载信息写入 /etc/fstab 文件中，格式为：
**设备文件 挂载目录 格式类型 权限选项 是否备份 是否自检**
- 设备文件：设备的路径+名称，或者为UUID
- 挂载目录：指定的挂载目录，需已经存在
- 格式类型：指定文件系统格式
- 权限选项：若设置为defaults，则为rw、suid、dev、exec、auto、nouser、async；\_netdev参数可以使系统在联网成功之后再尝试挂载该设备，常用于网络存储设备
- 是否备份：若为1则开机后使用dump进行磁盘备份，为0则不备份
- 是否自检：若为1则开机后自动进行磁盘自检。为0则不自检

写入 /etc/fstab 文件中的设备信息不会立即生效，需要使用 `mount -a`  进行自动挂载。

### df命令和lsblk命令
`df -h`
用于查看已经挂载的磁盘空间使用情况。

`lsblk`
用于以树状图形式查看已经挂载的磁盘空间使用情况。
### umount命令
`umount [设备文件/挂载目录]`
用于卸载设备或文件系统。需要在非操作设备目录下执行。


## 添加硬盘设备
### fdisk命令
`fdisk 磁盘名称`
用于新建、修改以及删除磁盘的分区信息。

参数：
- `m` 查看全部可用参数
- `n` 添加新的分区信息
- `d` 删除某个分区信息
- `l` 列出所有可用分区的类型
- `t` 改变某个分区的类型
- `p` 查看分区表信息
- `w` 保存并退出
- `q` 不保存直接退出

该命令参数输入为交互式。
使用 `fdisk` 命令后使用 `partprobe` 命令来将分区信息同步到内核。

### mkfs命令
`mkfs(.文件系统) 磁盘名称`
用于以指定的文件系统格式化硬盘。
例如，将分区以XFS文件系统格式化：
```Shell
mkfs.xfs /dev/sdb1
```

### du命令
`du -sh 目录名称`
用于查看分区或者目录所占用的磁盘容量大小。


## 添加交换分区
交换（SWAP）分区是一种通过在硬盘中预先划分一定的空间，将内存中暂时不常用的数据临时存放到硬盘中，以便腾出物理内存空间让更活跃的程序服务来使用的技术。即使用硬盘来模拟内存。
在生产环境中，交换分区的大小一般为真实物理内存的1.5～2倍。

### mkswap命令
`mkswap 设备名称`
用于对新设备进行交换分区格式化。

### swapon命令
`swapon 设备名称` 
用于激活新的交换分区设备。
若要使新的交换分区在设备重启后依然生效，需要按照`设备名称 swap swap defaults 0 0` 的格式将相关信息写入 /etc/fstab 文件中。


## 磁盘容量配额
使用quota技术进行磁盘容量配额管理。
- 软限制：当达到软限制会提示用户，担仍允许用户在限定的额度内继续使用
- 硬限制：当达到硬限制会提示用户，且强制终止用户的操作

并非所有Linux发行版均安装了quota服务。
存储设备默认没有开启对 quota 技术的支持，需要手动编辑配置文件并重启一次系统，让系统中的启动目录（/boot）能够支持quota磁盘配额技术。

在RHEL8系统下，在 /etc/fstab 文件中目录为 /boot 的一行中将 `defaults` 改为 `defaults, uquota` ，再重启系统即可。

### xfs_quota命令
`xfs_quota [参数] 配额 文件系统`
专门针对XFS文件系统来管理quota磁盘容量配额。

参数：
- `-c` 以参数形式设置
- `-x` 进行详细的设置

例如，给tom用户设置硬盘使用量软限制和硬限制分别为3MB和6MB，建立文件软限制和硬限制分别为3个和6个：
```Shell
xfs_quota -x -c 'limit bsoft=3m bhard=6m isoft=3 ihard=6 tom' /boot
```
查看限制情况：
```Shell
xfs_quota -x -c report /boot
```

isoft和ihard通过限制系统最大使用的inode个数来限制文件数量，bsoft和bhard通过限制文件所用block大小来限制文件大小。

### edquota命令
`edquota [参数] 用户名`
用于管理系统的硬盘配额。

参数：
- `-u` 对某个用户进行设置
- `-g` 对某个用户组进行设置
- `-p` 复制原有的规则到新的用户组
- `-t` 限制宽限期限

`edquota`命令会调用Vi或Vim编辑器来让root管理员修改要限制的具体细节。


## 虚拟数据优化（VDO）
虚拟数据优化（VDO）是一种通过压缩或删除存储设备上的数据来优化存储空间的技术。
并非所有Linux发行版都安装了VDO。

在部署虚拟机或容器时，建议采用逻辑存储与物理存储为10∶1 的比例进行配置；而部署对象存储时则采用逻辑存储与物理存储为 3∶1 的比例进行配置。

新添加进来的物理设备使用 `vdo` 命令来管理，
其中 `name` 参数代表新的设备卷的 名称；`device` 参数代表由哪块磁盘进行制作；`vdoLogicalSize` 参数代表制作后的设备大小。

例如，将20GB的硬盘作为200GB的逻辑存储：
```Shell
vdo creat --name=storage --device=/dev/sdc --vdoLogicalSize=200G
```
在创建成功后，使用 `status` 参数查看新建卷的概述信息:
```Shell
vdo status --name=storage
```
接下来，对新建卷进行格式化操作并挂载才能使用。
挂载前可以使用 `udevadm settle` 命令对设备进行一次刷新操作，避免刚才的配置没有生效。

查看设备的实际使用情况：
```Shell
vdostats --human-readable
```
其中 `--human-readable` 参数使存储容量自动进位。

VDO设备卷在创建后会一直存在,但需要手动编辑 /etc/fstab 文件后才能在下一次重启后自动挂载生效。


## 软硬方式链接
- 软链接：也称为符号链接，仅仅包含所链接文件的名称和路径。当原始文件被删除或移动后，新的链接文件也会随之失效，不能被访问。可以针对文件、目录设置软链接，也可以跨文件系统进行链接。
- 硬链接：是一个指向原始文件 block 的指针，系统会创建出一个与原来一模一样的inode信息块。每添加一个硬链接，该文件的inode个数就会增加 1， 只有当该文件的inode个数为0时，文件才被彻底删除。不能跨分区对目录文件进行硬链接。

### In命令
`In [参数] 原始文件名 链接文件名`
用于创建文件的软硬链接。

参数：
- `-s` 创建软链接（默认创建硬链接）
- `-f` 强制创建文件或目录的链接
- `-i` 覆盖前先询问
- `-v` 显示创建链接的过程


