## 独立冗余磁盘阵列（RAID）
RAID 技术通过把多个硬盘设备组合成一个容量更大、安全性更好的磁盘阵列，并把数据切割成多个区段后分别存放在各个不同的物理硬盘设备上，利用分散读写技术来提升磁盘阵列整体的性能，同时把多个重要数据的副本同步到不同的物理硬盘设备上，起到了非常好的数据冗余备份效果。

RAID 技术对比：

|RAID级别|最少硬盘|可用容量|读写性能|安全性|特点|
|---|---|---|---|---|---|
|0|2|n|n|低|追求最大容量和速度，但任何一块硬盘损坏，数据将全部异常|
|1|2|n/2|n|高|追求最大安全性，只要阵列中有一块硬盘可用，数据就不受影响|
|5|3|n-1|n-1|中|在控制成本的前提下，追求硬盘的最大容量、速度及安全性，允许有一块硬盘出现异常，且数据不受影响|
|10|4|n/2|n/2|高|综合 RAID 1 和 RAID 0 的优点，追求硬盘的速度和安全性，允许有一半硬盘出现异常（不可发生在同一阵列中），且数据不受影响|

### RAID 0
RAID 0 技术将多块物理硬盘设备（至少两块）通过硬件或软件的方式串联在一起，组成一个大的卷组，并将数据依次写入各个物理硬盘中。在最理想的状态下，硬盘设备的读写性能会提升数倍，但若任意一块硬盘发生故障，将导致整个系统的数据都受到破坏。

### RAID 1
RAID 1 技术将两块以上的硬盘设备进行绑定，在写入数据时，是将数据同时写入到多块硬盘设备上（可以将其视为数据的镜像或备份）。当其中某一块硬盘发生故障后，一般会立即自动以热交换的方式来恢复数据的正常使用。
RAID 1 技术虽然十分注重数据的安全性，但是因为是在多块硬盘设备中写入了相同的数据，导致硬盘设备的利用率下降。

### RAID 5
RAID5 技术是将硬盘设备的数据奇偶校验信息保存到其他硬盘设备中。RAID 5磁盘阵列中数据的奇偶校验信息并不是单独保存到某一块硬盘设备中，而是存储到除自身以外的其他每一块硬盘设备上。
RAID 5 技术实际上没有备份硬盘中的真实数据信息，而是当硬盘设备出现问题后通过奇偶校验信息来尝试重建损坏的数据。
RAID 5 至少由3块硬盘组成，使用硬盘切割技术。当重复写入某个文件时，RAID 5 级别的磁盘阵列组只需要对应一个奇偶校验信息就可以，效率更高，存储成本也会随之降低。

### RAID 10
RAID 10技术需要至少4块硬盘来组建，其中先分别两两制作成 RAID 1 磁盘阵列，以保证数据的安 全性；然后再对两个 RAID 1 磁盘阵列实施 RAID 0 技术，进一步提高硬盘设备的读写速度。RAID 10 技术继承了 RAID 0 的高读写速度和 RAID 1 的数据安全性.

### 部署磁盘阵列
`mdadm 参数 硬盘名称`
用于创建、调整、监控和管理 RAID 设备。

参数：
- `-a` 检测设备名称，向RAID中添加新设备
- `-n` 指定设备数量
- `-l` 指定 RAID 级别
- `-C` 创建
- `-v` 显示过程
- `-f` 模拟设备损坏
- `-r` 移除设备
- `-Q` 查看摘要信息
- `-D` 查看详细信息
- `-S` 停止 RAID 磁盘阵列
- `-x` 设置初始RAID设备的备用成员数量 

例如，使用四块20G的硬盘创建 RAID 10 阵列：
```Shell
mdadm -Cv /dev/md0 -n 4 -l 10 /dev/sdb /dev/sdc /dev/sdd /dev/sde
```
初始化需要一定时间。在这之后，需要将制作好的磁盘阵列格式化并挂载。若需要重启系统后依然使用，需要将相关信息写入 /etc/fstab 文件中。

### 损坏磁盘阵列及修复
在确认有一块物理硬盘设备出现损坏而不能再继续正常使用后，应该使用 `mdadm` 命令将其移除：
```Shell
mdadm /dev/md0 -r /dev/sdb
```
当购买了新的硬盘设备后再使用 `mdadm` 命令予以替换即可，在此期间可以在 /RAID 目录中正常地创建或删除文件。
更换硬盘后再次使用 `-a` 参数进行添加操作，系统默认会自动开始数据的同步工作：
```Shell
mdadm /dev/md0 -a /dev/sdb
```

RAID 备份盘技术的核心理念是准备一块足够大的硬盘，这块硬盘平时处于闲置状态，一旦 RAID 磁盘阵列中有硬盘出现故障后则会马上自动顶替上去。

### 删除磁盘阵列
要删除 RAID 磁盘阵列，首先将卸载磁盘设备：
```Shell
umount /RAID
```
再将所有硬盘设置为停用状态并移除：
```Shell
mdadm /dev/md0 -f /dev/sdb -r /dev/sdb

mdadm /dev/md0 -f /dev/sdc -r /dev/sdc

mdadm /dev/md0 -f /dev/sdd -r /dev/sdd

mdadm /dev/md0 -f /dev/sde -r /dev/sde
```
最后停用整个 RAID 磁盘阵列：
```Shell
mdadm --stop /dev/md0
```
若磁盘文件仍有残留，可执行进一步删除：
```Shell
mdadm --remove /dev/md0
```



## 逻辑卷管理器（LVM）
LVM 是用于对硬盘分区进行管理的一种机制，其创建初衷是为了解决硬盘设备在创建分区后不易修改分区大小的缺陷。
LVM 技术是在硬盘分区和文件系统之间添加了一个逻辑层，它提供了一个抽象的卷组（VG），可以把多块硬盘进行卷组合并。 用户不必关心物理硬盘设备的底层架构和布局，就可以实现对硬盘分区的动态调 整。
物理卷处于 LVM 中的最底层，一般是物理硬盘、硬盘分区或者 RAID 磁盘阵列。 卷组建立在物理卷之上，一个卷组能够包含多个物理卷，而且在卷组创建之后也可以继续向其中添加新的物理卷。逻辑卷是用卷组中空闲的资源建立的，并且逻辑卷在建立后可以动态地扩展或缩小空间。

常用 LVM 管理命令：

|功能|物理卷管理|卷组管理|逻辑卷管理|
|:---:|:---:|:---:|:---:|
|扫描|pvscan|vgscan|lvscan|
|建立|pvcreate|vgcreate|lvcreate|
|显示|pvdisplay|vgdisplay|lvdisplay|
|删除|pvremove|vgremove|lvremove|
|扩展||vgextend|lvextend|
|缩小||vgreduce|lvreduce|

### 部署逻辑卷
新添加两块硬盘设备后，
- 首先让新添加的两块硬盘支持 LVM 技术：
```Shell
pvcreate /dev/sdb /dev/sdc
```
- 接着将两块硬盘设备加入到 storage 卷组中，并查看卷组情况：
```Shell
vgcreate storage /dev/sdb /dev/sdc

vgdisplay
```
- 然后切割出一个 150MB 的逻辑卷设备，并查看逻辑卷情况：
```Shell
lvcreate -n vo -l 37 storage

lvdisplay
```
`lvcreate` 命令使用 `-L` 参数以容量切割，使用 `-l` 参数以基本单元个数切割，每个基本单元默认大小为 4MB。`-n` 参数设置了逻辑卷设备的名称。
- 然后将生成的逻辑卷进行格式化，再挂载使用。
Linux 系统会把 LVM 中的逻辑卷设备存放在 /dev 设备目录中， 同时会以卷组的名称来建立一个目录，其中保存了逻辑卷的设备映射文件（即 /dev/卷组名称/ 逻辑卷名称）。
```Shell
mkfs.ext4 /dev/storage/vo

mount /dev/storage/vo /linuxprobe
```
若使用了逻辑卷管理器，则不建议用 XFS 文件系统，因为 XFS 文件系统自身可以使用 `xfs_growfs` 命令进行磁盘扩容。
- 最后查看挂载状态，并写入 /etc/fstab 配置文件，使其永久生效:
```Shell
df -h
```

### 扩容逻辑卷
扩容逻辑卷之前一定要卸载设备和挂载目录的关联:
```Shell 
umount /linuxprobe
```
- 首先将逻辑卷 vo 扩展至 290MB：
```Shell
lvextend -L 290MB /dev/storage/vo
```
- 接着检查硬盘完整性，确认目录结构、内容和文件内容没有丢失：
```Shell
e2fsck -f /dev/storage/vo
```
- 然后重置设备在系统中的容量：
```Shell
resize2fs /dev/storage/vo
```
- 最后重新挂载硬盘设备并查看挂载状态：
```Shell
mount -a

df -h
```

### 缩小逻辑卷
与扩展逻辑卷相同，在缩小逻辑卷之前也需要卸载设备和挂载目录的关联：
```Shell
umount /linuxprobe
```
- 首先检查文件系统的完整性：
```Shell
e2fsck -f /dev/storage/vo
```
- 接着通知系统内核将逻辑卷 vo 的容量减少至 120MB：
```Shell
resize2fs /dev/storage/vo 120MB
```
- 然后将逻辑卷的容量修改为 120MB：
```Shell
lvreduce -L 120MB /dev/storage/vo
```
- 最重新挂载文件系统并查看挂载状态：
```Shell
mount -a

df -h
```

### 逻辑卷快照
LVM 具有快照卷功能，相当于还原时间点，对于某个逻辑卷进行一次快照，日后可使用快照进行覆盖恢复。
- 快照卷的容量必须等同于逻辑卷的容量。
- 快照卷仅一次有效，一旦执行还原操作后则会被立即自动删除。

创建并使用一个逻辑卷快照：
- 在正式操作前，先查看 卷组中的容量是否够用：
```Shell
vgdisplay
```
- 创建逻辑卷 vo 的一个快照卷：
```Shell
lvcreate -L 120MB -s -n SNAP /dev/storage/vo
```
`-s`参数生成一个快照卷，对此时逻辑卷 vo 中的文件进行了备份。
- 在对逻辑卷进行快照还原之前，需要卸载逻辑卷设备与目录的挂载：
```Shell
umount /linuxprobe
```
- 接着使用 `lvconcert` 命令使逻辑卷恢复到快照状态：
```Shell
lvconcert --merge /dev/storage/SNAP
```
- 最后再重新挂载逻辑卷设备，此时快照卷已经被删除：
```
mount -a
```

### 删除逻辑卷
需要按照删除逻辑卷、卷组、物理卷设备的顺序进行操作。
- 首先取消逻辑卷与目录的挂载关联，删除配置文件中永久生效的设备参数：
```Shell
umount /linuxprobe

vim /etc/fstab
```
- 接着删除逻辑卷设备，需要输入 `y` 来确认操作：
```Shell
lvremove /dev/storage/vo
```
- 然后删除卷组，只需提供卷组名称：
```Shell
vgremove storage
```
- 最后删除物理卷设备：
```Shell
pvremove /dev/sdb /dev/sdc
```

